---
title: "Assignment 4 - A working Title"
author: "Anthony Luna & Elliott Matthews"
date: "11/9/2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)
```
```{r}
library(tidyverse)
library(janitor)
library(kableExtra)
library(scales)
library(here)
library(broom)
library(purrr)
```

### Introduction

### Data and Methods

### Results

#### Results A: Visually Explore changes in annual lobster abundance (counts) by site {.tabset}

```{r}
# Import of raw data, and cleaning for use which includes uncounting
# the data set, cleaning the names, and adding a column for California
# fish and game network (cfgn) marine status.

lob_raw <- read_csv(here("data","lobster_abundance_sbc_lter.csv"), na = "-99999") %>% 
  clean_names() %>% 
  uncount(weights = count) %>% 
  mutate(cfgn_code = case_when(site %in% c("NAPL","IVEE")~"MPA",TRUE~"non-MPA"))

# Creating a dataframe which summarizes the lobster counts by year, 
# site, and cfgn_code.

lob_year_site <- lob_raw %>% 
  group_by(year,site, cfgn_code) %>% 
  summarise(count = n()) %>% 
  mutate(site2 = as.factor(site))

```

These tabs show each of the regions

##### Arroyo Quemado 

**MPA Designation: ** Not a designated MPA site.


```{r}
lob_year_site %>% 
  ggplot(aes(x = year, y = count)) +
  geom_line(data = lob_year_site %>% dplyr::select(-site2),color="grey", aes(group=site)) +
  geom_line(data = lob_year_site %>% dplyr::select(-site) %>% filter(site2 == "AQUE"), color="#CC60A8",size=1.2) +
  theme_minimal()+
  theme(legend.position = "none")

```

##### Carpinteria

**MPA Designation**: Not a designated MPA site.


```{r}
 lob_year_site %>% 
  ggplot(aes(x = year, y = count)) +
  geom_line(data = lob_year_site %>% dplyr::select(-site2),color="grey", aes(group=site)) +
  geom_line(data = lob_year_site %>% dplyr::select(-site) %>% filter(site2 == "CARP"),color="#CC60A8",size=1.2) +
  theme_minimal()+
  theme(legend.position = "none")
```

##### Isla Vista

**MPA Designation**: Desginated a MPA site in January 1^st^, 2012

```{r}
lob_year_site %>% 
  ggplot(aes(x = year, y = count)) +
  geom_line(data = lob_year_site %>% dplyr::select(-site2),color="grey", aes(group=site)) +
  geom_line(data = lob_year_site %>% dplyr::select(-site) %>% filter(site2 == "IVEE"),color="#CC60A8",size=1.2) +
  theme_minimal()+
  theme(legend.position = "none")
```

##### Mohawk

**MPA Designation**: Not a designated MPA site.

```{r}
lob_year_site %>% 
  ggplot(aes(x = year, y = count)) +
  geom_line(data = lob_year_site %>% dplyr::select(-site2),color="grey", aes(group=site)) +
  geom_line(data = lob_year_site %>% dplyr::select(-site) %>% filter(site2 == "MOHK"),color="#CC60A8",size=1.2) +
  theme_minimal()+
  theme(legend.position = "none")
```

##### Naples

**MPA Designation**: Desginated a MPA site in January 1^st^, 2012

```{r}
lob_year_site %>% 
  ggplot(aes(x = year, y = count)) +
  geom_line(data = lob_year_site %>% dplyr::select(-site2),color="grey", aes(group=site)) +
  geom_line(data = lob_year_site %>% dplyr::select(-site) %>% filter(site2 == "NAPL"),color="#CC60A8",size=1.2) +
  theme_minimal()+
  theme(legend.position = "none")
```




#### Results B: Visually explore lobster size distribution shifts by comparing lobster sizes in 2012 and 2018

```{r}
lob_size_2018 <- lob_raw %>% 
  filter(!is.na(size_mm)) %>% 
  filter(year==2018) 
lob_size_2012 <- lob_raw %>%    
  filter(!is.na(size_mm)) %>% 
  filter(year==2012)

# To overlay do not insert any data or aes into intial ggplot(). 
# If you do it causes that to be applied to all following plots. 
# In this instance since we are using multiple data frames  we 
# need to map the aes per data frame.

ggplot() + 
  geom_violin(data = lob_size_2012, 
            aes (x = site, y = size_mm, fill = as.factor(year)), alpha = .5) +
  geom_violin(data = lob_size_2018, 
            aes (x = site, y = size_mm, fill = as.factor(year)), alpha = .5) +
  facet_grid(~cfgn_code, scales = "free", space = "free")+

  labs(title = "Comparison of Lobster size in 2012 vs 2018",
       x = "Catch site",
       y = "Size (mm)") +
  theme(plot.title = element_text(hjust= 0.5),
          plot.subtitle = element_text(hjust= 0.5))
  
  #####################  Change legend to show 2018 is grey, and 2012 is solid##############


```


#### Results C: Compare mean lobster sizes at MPA vs. non-MPA status sites in 2012 and 2018

```{r}
### Create data frames for statistical analysis. ###

# Mean size of lobsters in 2012

mpa_size_2012 <- lob_raw %>% 
  filter(year == 2012) %>%
  filter(cfgn_code == "MPA") %>% 
  filter(!is.na(size_mm)) 

non_mpa_size_2012 <- lob_raw %>% 
  filter(year == 2012) %>%
  filter(cfgn_code == "non-MPA") %>% 
  filter(!is.na(size_mm)) 

# Mean size of lobsters in 2018

mpa_size_2018 <- lob_raw %>% 
  filter(year == 2018) %>%
  filter(cfgn_code == "MPA" ) %>% 
  filter(!is.na(size_mm)) 

non_mpa_size_2018 <- lob_raw %>% 
  filter(year == 2018) %>%
  filter(cfgn_code == "non-MPA") %>% 
  filter(!is.na(size_mm))

### Perform t-tests on data to determine if there is a significant difference between lobster sites in:

# 1. 2012 MPA and non MPA sites 

mpa_vs_non_2012 <- t.test(
  mpa_size_2012$size_mm, non_mpa_size_2012$size_mm)

# 2. 2018 MPA and non MPA sites

mpa_vs_non_2018 <- t.test(
  mpa_size_2018$size_mm, non_mpa_size_2018$size_mm)

# 3. MPA sites only 2012 vs 2018

mpa_2012_vs_mpa_2018 <- t.test(
  mpa_size_2012$size_mm, mpa_size_2018$size_mm)

# 4. non MPA sites only 2012 vs 2018

non_mpa_2012_vs_non_mpa_2018 <- t.test(
  non_mpa_size_2012$size_mm, non_mpa_size_2018$size_mm)

t_table <- map_df(list(mpa_vs_non_2012, mpa_vs_non_2018, mpa_2012_vs_mpa_2018, non_mpa_2012_vs_non_mpa_2018),tidy) 

kable(t_table,
      caption = "Table 1: Welch Two Sample t-test")


```

```{r}
### Create summary table with mean, standard deviation, and sample count

final_summary_table <- lob_raw %>% 
  filter(year %in% c(2012, 2018)) %>% 
  group_by(cfgn_code,year) %>% 
  summarize(
    mean = round(mean(size_mm),1),
    s_dev = round(sd(size_mm),1),
    count = n())

kable(final_summary_table[2:5], 
        caption = "Table 1: Lobster summary statistics",
        col.names = c("Year",
                      "Mean (mm)",
                      "\u03C3 (\u00B1 mm)  ",
                      "Count")) %>% 
  kable_styling("striped",full_width = F) %>% 
  pack_rows("MPA Site", 1,2) %>% 
  pack_rows("Non-MPA Site",3,4)
  
```


### Summary

### References